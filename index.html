<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab sheet</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div style="display: flex; flex-direction: column;">
        <div style="display: flex; flex-direction: row;">
            <nav>
                <ul id="navbar">
                </ul>
            </nav>
            <button id="unhideAll">Unhide All</button>
        </div>
        <div id="data"></div>
    </div>

    <script>

        function renderNavbar() {
            let html = '';
            let counter = 1
            const data = fetch('source.json')
                .then(response => response.json())
                .then(data => data.forEach(item => {
                    html += `<li><p>${counter}</p><ul>`
                    item.forEach(it => {
                        html += `<li><button onClick="addWordList('core/${counter}${it}.csv')">${it}</button></li>`
                    })
                    html += `</ul></li>`
                    counter++
                }))
                .then(_ => {
                    res = `<li><p>Jlpt</p><ul><li><button onClick="addWordList('jlpt/n5.csv')">N5</button></li>`
                    res += `<li><button onClick="addWordList('jlpt/n4.csv')">N4</button></li></ul></li>`
                    res += html
                    document.getElementById('navbar').innerHTML = res;
                })
                .catch(error => console.error('Error:', error));
        }

        function addWordList(name) {
            fetch('vocab/' + name)
                .then(response => response.text())
                .then(csvText => {
                    let html = '<table id="vocabList">';
                    let i = 0;
                    csvText.split('\n').forEach(row => {
                        html += '<tr><td>' + i + '</td>';
                        row.split(',').forEach(column => {
                            column = column.replace(/<rt>(.*?)<\/rt>/g, '<rt><span class="furigana">$1</span></rt>');
                            html += '<td class="vocab-cell">' + column + '</td>';
                        });
                        html += '</tr>';
                        i++;
                    });
                    html += '</table>';
                    document.getElementById('data').innerHTML = html;

                    const table = document.getElementById("vocabList");
                    let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");

                    [...table.rows].forEach((r, i) => {
                        if (i && hidden.includes(i)) collapse(r, i, name);
                        r.onclick = e => {
                            if (e.ctrlKey) {
                                collapse(r, i, name);
                                hidden.push(i);
                                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
                            }
                        };
                    });
                })
                .catch(error => console.error('Error fetching CSV:', error));

            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("vocab-cell")) {
                    document.querySelectorAll(".vocab-cell").forEach(cell => cell.classList.remove("clicked"));
                    e.target.classList.add("clicked");
                }
            });
        }

        function collapse(row, i, name) {
            let placeholder = document.createElement("tr");
            placeholder.innerHTML = `<td colspan="${row.cells.length}" class="hiddenrow"><hr class="hiddenbar"></td>`;
            placeholder.onclick = () => {
                placeholder.replaceWith(row);
                let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");
                hidden = hidden.filter(x => x !== i);
                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
            };
            row.replaceWith(placeholder);
        }


        addWordList('core/' + 1 + 'all.csv')

        renderNavbar();

        document.getElementById("unhideAll").onclick = () => { Object.keys(localStorage).forEach(key => { if (key.startsWith("hiddenRows_")) localStorage.removeItem(key); }); location.reload(); };
    </script>
</body>

</html>