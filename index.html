<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本語 Vocab Sheet</title>
    <link rel="icon" type="image/x-icon" href="/styles/feather.ico">
    <link rel="stylesheet" href="./styles/style.css">
</head>

<body>
    <div style="display: flex; flex-direction: column;">
        <div class="backlogoptions">
            <div class="navdiv">
                <button class="btn" onClick="randomizeCSV()">⚅</button>
                <div class="btn3">
                    <button class="updbutton" id="menuBtn" style="height:25px;width:25px;">⇅</button>
                    <div id="menu" class="backlogoptions" style="display:none">
                        <input type="file" id="uploadBacklog" accept=".csv" style="display:none"
                            onchange="uploadBacklog(event)">
                        <button class="backlogbutton"
                            onclick="document.getElementById('uploadBacklog').click()">Import</button>
                        <button class="backlogbutton" onclick="downloadBacklog()">Export</button>
                    </div>
                </div>
                <button class="btn2" onClick="addBacklog()">Backlog</button>
                <button class="btn2" onClick="sortColoredRows()">Sort Colors</button>
                <nav>
                    <ul id="navbar"></ul>
                </nav>
                <button id="unhide" class="btn" style="display:none">.</button>
                <!-- <div>show furigana<input type="checkbox" class="switch_1" id="switch"></div>
                <div>hide hints<input type="checkbox" class="switch_1" id="toggleCol3Slider"></div> -->
                <input type="checkbox" class="switch_1" id="switch">
                <input type="checkbox" class="switch_1" id="toggleCol3Slider">
            </div>
        </div>
        <div id="data"></div>
    </div>

    <script>
        let isBacklog = false;
        let current = 'core/' + 1 + 'all.csv';

        function downloadBacklog() {
            const backlog = JSON.parse(localStorage.getItem("backlog_") || "[]");
            const csv = backlog.map(r => (r.cells || r).map(c => ("" + c).replace(/\r?\n/g, " ")).join(",")).join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "backlog_" + new Date().toLocaleDateString('ja-JP') + ".csv";
            a.click();
        }

        function uploadBacklog(e) {
            const file = e.target.files[0];
            if (!file) return;
            file.text().then(text => {
                const rows = text.split("\n").map(r => ({
                    cells: r.split(","),
                    color: null
                }));
                localStorage.setItem("backlog_", JSON.stringify(rows));
                alert("Uploaded backlog.");
                document.getElementById('menu').style.display = 'none';
                addBacklog();
            });
        }

        document.getElementById("menuBtn").onclick = () => {
            const m = document.getElementById("menu");
            m.style.display = m.style.display === "none" ? "block" : "none";
        };

        document.addEventListener('click', e => {
            const menu = document.getElementById('menu');
            if (menu.style.display === 'block' && !menu.contains(e.target) && e.target.id !== 'menuBtn') {
                menu.style.display = 'none';
            }
        });

        let lastScroll = window.scrollY;
        const nav = document.querySelector('.navdiv');
        document.querySelector('.navdiv').style.transform = 'translateY(0)';

        window.addEventListener('scroll', () => {
            const current = window.scrollY;
            if (current !== lastScroll) {
                if (current < lastScroll) {
                    nav.style.transform = 'translateY(0)';
                    nav.classList.add("upscroll");
                } else {
                    nav.style.transform = 'translateY(-100%)';
                    document.getElementById('menu').style.display = 'none';
                }
                lastScroll = current;
            }
            if (window.scrollY === 0) {
                nav.classList.remove('upscroll');
            }
        });

        document.addEventListener('keydown', e => {
            if (e.altKey) document.body.style.cursor = 'copy';
        });

        document.addEventListener('keyup', e => {
            if (!e.altKey) document.body.style.cursor = '';
        });

        function createParticle(parentElement = document.body) {
            const particle = document.createElement("div");
            particle.classList.add("particle");
            particle.innerHTML = "<h1 style='font-size:3em'>+</h1>";
            if (parentElement) {
                parentElement.append(particle);
            }
            return particle;
        }

        document.querySelector('.switch_1').addEventListener('change', e => {
            document.body.classList.toggle('show-furigana', e.target.checked);
        });

        function renderNavbar() {
            let html = '';
            let counter = 1
            const data = fetch('source.json')
                .then(response => response.json())
                .then(data => data.forEach(item => {
                    html += `<li><p>${counter}</p><ul>`
                    item.forEach(it => {
                        html += `<li><a class="" onClick="addWordList('core/${counter}${it}.csv')">${it}</a></li>`
                    })
                    html += `</ul></li>`
                    counter++
                }))
                .then(_ => {
                    res = `<li><p>Jlpt</p><ul><li><a class="" onClick="addWordList('jlpt/n5.csv')">N5</a></li>`
                    res += `<li><a class="" onClick="addWordList('jlpt/n4.csv')">N4</a></li></ul></li>`
                    res += html
                    document.getElementById('navbar').innerHTML = res;
                })
                .catch(error => console.error('Error:', error));
        }

        let menu = document.getElementById("contextMenu");
        if (!menu) {
            menu = document.createElement("div");
            menu.id = "contextMenu";
            menu.className = "context-menu";
            document.body.appendChild(menu);
            document.addEventListener("click", () => menu.classList.remove("visible"));
        }

        function addBacklog(randomize = false) {
            isBacklog = true;
            let backlog = JSON.parse(localStorage.getItem("backlog_") || "[]");
            backlog.sort((a, b) => (b.cells.at(-1) || "").localeCompare(a.cells.at(-1) || ""));

            if (randomize) {
                const grouped = {};
                backlog.forEach(r => (grouped[r.cells.at(-1)] ||= []).push(r));
                backlog = Object.values(grouped).flatMap(g => g.sort(() => Math.random() - 0.5));
            }

            let html = '<table id="vocabList">';
            let prev = null;
            backlog.forEach((row, idx) => {
                const group = row.cells.at(-1);
                if (group !== prev && prev !== null) html += `<tr style="background:#444"><td colspan="${row.cells.length + 1}"></td></tr>`;
                prev = group;

                html += `<tr data-index="${idx}" ${row.color ? `data-color="${row.color}" class="row-${row.color}"` : ""}>
            <td>${idx}</td>${row.cells.map(c => `<td class="vocab-cell">${c}</td>`).join('')}</tr>`;
            });
            html += '</table>';
            document.getElementById('data').innerHTML = html;
            resetCol3Slider();

            document.querySelectorAll("#vocabList tr").forEach(row => {
                row.onclick = e => {
                    if (e.altKey) {
                        backlog.splice(row.dataset.index, 1);
                        localStorage.setItem("backlog_", JSON.stringify(backlog));
                        addBacklog(randomize);
                    }
                };

                const isMobile = /Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent);
                if (!isMobile) {
                    row.oncontextmenu = e => {
                        e.preventDefault();
                        const color = row.dataset.color || "";
                        menu.innerHTML = color
                            ? `<div class="menu-item" data-action="clear">Clear</div>`
                            : `<div class="menu-item" data-color="blue">Blue</div>
                   <div class="menu-item" data-color="teal">Teal</div>`;
                        menu.style.left = e.pageX + "px";
                        menu.style.top = e.pageY + "px";
                        menu.classList.add("visible");

                        menu.querySelectorAll(".menu-item").forEach(item => {
                            item.onclick = () => {
                                const idx = row.dataset.index;
                                row.classList.remove("row-teal", "row-blue");
                                delete row.dataset.color;

                                if (item.dataset.color) {
                                    const cls = `row-${item.dataset.color}`;
                                    row.classList.add(cls);
                                    row.dataset.color = item.dataset.color;
                                    backlog[idx].color = item.dataset.color;
                                } else {
                                    backlog[idx].color = null;
                                }

                                localStorage.setItem("backlog_", JSON.stringify(backlog));
                                menu.classList.remove("visible");
                            };
                        });
                    };
                }
            });
        }

        function addWordList(name, randomize) {
            isBacklog = false;
            current = name;
            fetch('vocab/' + name)
                .then(response => response.text())
                .then(csvText => {
                    let rows = csvText.split('\n');
                    if (randomize) rows = rows.sort(() => Math.random() - 0.5);

                    let html = '<table id="vocabList">';
                    rows.forEach((row, i) => {
                        html += '<tr><td>' + i + '</td>';
                        row.split(',').forEach(column => {
                            column = column.replace(/<rt>(.*?)<\/rt>/g, '<rt><span class="furigana">$1</span></rt>');
                            html += '<td class="vocab-cell">' + column + '</td>';
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    document.getElementById('data').innerHTML = html;
                    resetCol3Slider();

                    if (document.getElementById('switch').checked) {
                        document.body.classList.add('show-furigana');
                    }

                    const table = document.getElementById("vocabList");
                    let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");
                    let backlog = JSON.parse(localStorage.getItem("backlog_") || "[]");

                    [...table.rows].forEach((row, i) => {
                        if (i && hidden.includes(i) && !randomize) collapse(row, i, name);
                        row.onclick = e => {
                            if (e.ctrlKey) {
                                collapse(row, i, name);
                                hidden.push(i);
                                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
                            }
                            else if (e.altKey) {
                                e.preventDefault();
                                const rowData = [...row.cells].slice(1).map(cell => cell.innerHTML);
                                rowData.splice(5, 1);
                                rowData.push(extractName(name));

                                // Wrap as an object with color property
                                const rowObj = { cells: rowData, color: null };

                                if (!backlog.some(r => r.cells?.join() === rowObj.cells.join() || r.join?.() === rowObj.cells.join())) {
                                    backlog.push(rowObj);
                                    localStorage.setItem("backlog_", JSON.stringify(backlog));

                                    const p = createParticle(row);
                                    p.style.left = e.pageX + 'px';
                                    p.style.top = e.pageY + 'px';
                                    setTimeout(() => p.remove(), 1000);
                                }
                            }
                        };
                    });
                })
                .catch(error => console.error('Error fetching CSV:', error));

            document.addEventListener("click", (e) => {
                if (e.ctrlKey || e.altKey) return;
                if (e.target.classList.contains("vocab-cell")) {
                    document.querySelectorAll(".vocab-cell").forEach(cell => cell.classList.remove("hidden"));
                    e.target.classList.add("hidden");
                }
            });
        }

        function extractName(str) {
            return str.replace(/.*\/(.*?)\.csv$/, '$1');
        }

        function collapse(row, i, name) {
            let placeholder = document.createElement("tr");
            placeholder.innerHTML = `<td colspan="${row.cells.length}" class="hiddenrow"><hr class="hiddenbar"></td>`;
            placeholder.onclick = () => {
                placeholder.replaceWith(row);
                let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");
                hidden = hidden.filter(x => x !== i);
                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
            };
            row.replaceWith(placeholder);
        }

        document.getElementById("unhide").onclick = () => { Object.keys(localStorage).forEach(key => { if (key.startsWith("hiddenRows_")) localStorage.removeItem(key); }); location.reload(); };

        let col3Hidden = false;

        document.getElementById("toggleCol3Slider").addEventListener("change", (e) => {
            const table = document.getElementById("vocabList");
            if (!table) return;

            [...table.rows].forEach(row => {
                if (row.cells.length > 2) row.cells[2].style.display = e.target.checked ? "none" : "";
                if (row.cells.length > 3) row.cells[3].style.display = e.target.checked ? "none" : "";
                if (row.cells.length > 6) row.cells[6].style.display = e.target.checked ? "none" : "";
            });
        });

        function resetCol3Slider() {
            const slider = document.getElementById("toggleCol3Slider");
            slider.checked = false;
        }

        function randomizeCSV() {
            if (isBacklog) {
                addBacklog(true)
            }
            else {
                addWordList(current, true)
            }
        }

        function sortColoredRows() {
            const t = document.getElementById("vocabList");
            if (!t) return;
            const rows = [...t.rows];
            const order = { blue: 1, teal: 2, "": 3 };

            const groups = {};
            rows.forEach(r => {
                const cat = r.cells[r.cells.length - 1]?.textContent.trim() || "";
                (groups[cat] ||= []).push(r);
            });

            Object.values(groups).forEach(g => g.sort((a, b) =>
                (order[a.dataset.color || ""] - order[b.dataset.color || ""])
            ));

            t.replaceChildren(...Object.values(groups).flat());
        }

        addWordList(current)
        let lastCSV = current;
        renderNavbar();

    </script>
</body>

</html>