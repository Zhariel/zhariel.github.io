<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab sheet</title>
    <link rel="stylesheet" href="./styles/style.css">
</head>

<body>
    <div style="display: flex; flex-direction: column;">
        <div style="display: flex; flex-direction: row; justify-content: space-evenly;">
            <div class="navdiv">
                <button class="btn2" onClick="addBacklog()">Backlog</button>
                <nav>
                    <ul id="navbar"></ul>
                </nav>
                <button id="unhide" class="btn">.</button>
                <input type="checkbox" class="switch_1" id="switch">
            </div>
        </div>
        <div id="data"></div>
    </div>

    <script>
        document.querySelector('.switch_1').addEventListener('change', e => {
            document.body.classList.toggle('show-furigana', e.target.checked);
        });

        function renderNavbar() {
            let html = '';
            let counter = 1
            const data = fetch('source.json')
                .then(response => response.json())
                .then(data => data.forEach(item => {
                    html += `<li><p>${counter}</p><ul>`
                    item.forEach(it => {
                        html += `<li><a class="" onClick="addWordList('core/${counter}${it}.csv')">${it}</a></li>`
                    })
                    html += `</ul></li>`
                    counter++
                }))
                .then(_ => {
                    res = `<li><p>Jlpt</p><ul><li><a class="" onClick="addWordList('jlpt/n5.csv')">N5</a></li>`
                    res += `<li><a class="" onClick="addWordList('jlpt/n4.csv')">N4</a></li></ul></li>`
                    res += html
                    document.getElementById('navbar').innerHTML = res;
                })
                .catch(error => console.error('Error:', error));
        }

        function addBacklog() {
            let backlog = JSON.parse(localStorage.getItem("backlog_") || "[]");

            let html = '<table id="vocabList">';
            backlog.forEach((row, index) => {
                html += '<tr>';
                html += '<td>' + index + '</td>';
                row.forEach(col => {
                    html += '<td class="vocab-cell">' + col + '</td>';
                });
                html += '</tr>';
            });
            html += '</table>';

            document.getElementById('data').innerHTML = html;

            document.querySelectorAll("#vocabList tr").forEach((row, i) => {
                row.onclick = e => {
                    if (e.altKey) {
                        backlog.splice(i, 1);
                        localStorage.setItem("backlog_", JSON.stringify(backlog));
                        addBacklog();
                    }
                };
            });
        }

        function addWordList(name) {
            fetch('vocab/' + name)
                .then(response => response.text())
                .then(csvText => {
                    let html = '<table id="vocabList">';
                    let i = 0;
                    csvText.split('\n').forEach(row => {
                        html += '<tr><td>' + i + '</td>';
                        row.split(',').forEach(column => {
                            column = column.replace(/<rt>(.*?)<\/rt>/g, '<rt><span class="furigana">$1</span></rt>');
                            html += '<td class="vocab-cell">' + column + '</td>';
                        });
                        html += '</tr>';
                        i++;
                    });
                    html += '</table>';
                    document.getElementById('data').innerHTML = html;

                    if (document.getElementById('switch').checked) {
                        document.body.classList.add('show-furigana');
                    }

                    const table = document.getElementById("vocabList");
                    let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");
                    let backlog = JSON.parse(localStorage.getItem("backlog_") || "[]");

                    [...table.rows].forEach((row, i) => {
                        if (i && hidden.includes(i)) collapse(row, i, name);
                        row.onclick = e => {
                            if (e.ctrlKey) {
                                collapse(row, i, name);
                                hidden.push(i);
                                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
                            }
                            else if (e.altKey) {
                                const rowData = [...row.cells].slice(1).map(cell => cell.innerHTML);
                                if (!backlog.some(r => JSON.stringify(r) === JSON.stringify(rowData))) {
                                    rowData.splice(5, 1);
                                    rowData.push(extractName(name));
                                    backlog.push(rowData);
                                    localStorage.setItem("backlog_", JSON.stringify(backlog));
                                }
                            }
                        };
                    });
                })
                .catch(error => console.error('Error fetching CSV:', error));

            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("vocab-cell")) {
                    document.querySelectorAll(".vocab-cell").forEach(cell => cell.classList.remove("hidden"));
                    e.target.classList.add("hidden");
                }
            });
        }

        function extractName(str) {
            return str.replace(/.*\/(.*?)\.csv$/, '$1');
        }

        function collapse(row, i, name) {
            let placeholder = document.createElement("tr");
            placeholder.innerHTML = `<td colspan="${row.cells.length}" class="hiddenrow"><hr class="hiddenbar"></td>`;
            placeholder.onclick = () => {
                placeholder.replaceWith(row);
                let hidden = JSON.parse(localStorage.getItem("hiddenRows_" + name) || "[]");
                hidden = hidden.filter(x => x !== i);
                localStorage.setItem("hiddenRows_" + name, JSON.stringify(hidden));
            };
            row.replaceWith(placeholder);
        }

        addWordList('core/' + 1 + 'all.csv')
        renderNavbar();

        document.getElementById("unhide").onclick = () => { Object.keys(localStorage).forEach(key => { if (key.startsWith("hiddenRows_")) localStorage.removeItem(key); }); location.reload(); };
    </script>
</body>

</html>